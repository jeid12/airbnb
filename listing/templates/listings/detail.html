{% extends "base.html" %}
{% block title %}{{ listing.title }} - Lent bnb{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Breadcrumb -->
  <nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="{% url 'listings:home' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-red-600">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 101.414 1.414L8 5.414V17a1 1 0 102 0V5.414l6.293 6.293a1 1 0 001.414-1.414l-9-9z"/>
          </svg>
          Home
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{{ listing.location }}</span>
        </div>
      </li>
    </ol>
  </nav>

  <!-- Main Image Gallery -->
  {% if listing.image %}
  <div class="relative mb-8 rounded-xl overflow-hidden">
    <div class="aspect-w-16 aspect-h-9">
      <img src="{{ listing.image.url }}" 
           alt="{{ listing.title }}" 
           class="w-full h-96 lg:h-[500px] object-cover">
    </div>
    
    <!-- Image Overlay Elements -->
    <div class="absolute top-4 left-4">
      <span class="bg-white text-gray-800 px-3 py-1.5 rounded-full text-sm font-medium shadow-lg">
        {{ listing.get_property_type_display }}
      </span>
    </div>
    
    <!-- Share and Save buttons -->
    <div class="absolute top-4 right-4 flex space-x-2">
      <button title="Share" class="bg-white rounded-full p-2 shadow-lg hover:shadow-xl transition-shadow duration-200">
        <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
        </svg>
      </button>
      {% if user.is_authenticated and user.role == 'guest' %}
      <button title="Save to wishlist" class="bg-white rounded-full p-2 shadow-lg hover:shadow-xl transition-shadow duration-200">
        <svg class="w-4 h-4 text-gray-700 hover:fill-red-500 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
      </button>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
    <!-- Main Content -->
    <div class="lg:col-span-2">
      <!-- Title and Price -->
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ listing.title }}</h1>
          <div class="flex items-center text-gray-600 mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            {{ listing.location }}
          </div>
        </div>
        <div class="text-right">
          <p class="text-3xl font-bold text-red-600">${{ listing.price_per_night }}</p>
          <p class="text-gray-500">per night</p>
        </div>
      </div>

      <!-- Property Details -->
      <div class="bg-gray-50 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Property Details</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <svg class="w-6 h-6 mx-auto mb-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <p class="font-semibold">{{ listing.guests }}</p>
              <p class="text-sm text-gray-600">guest{{ listing.guests|pluralize }}</p>
            </div>
          </div>
          <div class="text-center">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <svg class="w-6 h-6 mx-auto mb-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v0zM3 7l9-4 9 4" />
              </svg>
              <p class="font-semibold">{{ listing.bedrooms }}</p>
              <p class="text-sm text-gray-600">bedroom{{ listing.bedrooms|pluralize }}</p>
            </div>
          </div>
          <div class="text-center">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <svg class="w-6 h-6 mx-auto mb-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v0zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="font-semibold">{{ listing.beds }}</p>
              <p class="text-sm text-gray-600">bed{{ listing.beds|pluralize }}</p>
            </div>
          </div>
          <div class="text-center">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <svg class="w-6 h-6 mx-auto mb-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
              </svg>
              <p class="font-semibold">{{ listing.bathrooms }}</p>
              <p class="text-sm text-gray-600">bathroom{{ listing.bathrooms|pluralize }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-4">About this place</h2>
        <p class="text-gray-700 leading-relaxed">{{ listing.description }}</p>
      </div>

      <!-- Host Actions -->
      {% if user.is_authenticated and user == listing.host %}
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3 flex-1">
            <h3 class="text-sm font-medium text-blue-800">This is your listing</h3>
            <div class="mt-2 text-sm text-blue-700">
              <p>You're viewing your own property listing. You can edit or delete it using the controls below.</p>
            </div>
            <div class="mt-4 space-x-3">
              <a href="{% url 'listings:edit' listing.pk %}" 
                 class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit Listing
              </a>
              <form action="{% url 'listings:delete' listing.pk %}" method="post" class="inline">
                {% csrf_token %}
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200"
                        onclick="return confirm('Are you sure you want to delete this listing? This action cannot be undone.');">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                  Delete Listing
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <!-- Booking Card -->
      {% if user.is_authenticated and user.role == 'guest' %}
      <div class="bg-white rounded-lg shadow-lg border p-6 mb-6 sticky top-4">
        <div class="text-center mb-4">
          <p class="text-2xl font-bold text-red-600">${{ listing.price_per_night }}</p>
          <p class="text-gray-500">per night</p>
        </div>
        
        <form id="booking-preview-form" class="space-y-4 mb-6">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Check-in</label>
              <input type="date" id="preview-checkin" title="Check-in date" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                     min="{{ today_date|date:'Y-m-d' }}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Check-out</label>
              <input type="date" id="preview-checkout" title="Check-out date" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                     min="{{ today_date|date:'Y-m-d' }}">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Guests</label>
            <select id="preview-guests" title="Number of guests" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
              {% for i in "123456789"|make_list %}
                {% if i|add:0 <= listing.guests %}
                  <option value="{{ i }}" {% if i == "1" %}selected{% endif %}>{{ i }} guest{{ i|pluralize }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </form>
        
        <!-- Price Breakdown (Hidden initially) -->
        <div id="price-breakdown" class="mb-4 p-3 bg-gray-50 rounded-lg hidden">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>${{ listing.price_per_night }} × <span id="nights-display">0</span> nights</span>
              <span id="subtotal-display">$0</span>
            </div>
            <div class="border-t pt-2">
              <div class="flex justify-between font-semibold">
                <span>Total before taxes</span>
                <span id="total-display">$0</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Availability Status -->
        <div id="availability-status" class="mb-4 hidden">
          <div id="available-message" class="p-3 bg-green-50 border border-green-200 rounded-lg hidden">
            <p class="text-green-700 text-sm">
              <i class="fas fa-check-circle mr-2"></i>Available for your dates!
            </p>
          </div>
          <div id="unavailable-message" class="p-3 bg-red-50 border border-red-200 rounded-lg hidden">
            <p class="text-red-700 text-sm">
              <i class="fas fa-exclamation-circle mr-2"></i>Not available for selected dates
            </p>
          </div>
          <div id="loading-message" class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <p class="text-blue-700 text-sm">
              <i class="fas fa-spinner fa-spin mr-2"></i>Checking availability...
            </p>
          </div>
        </div>
        
        <button id="book-now-btn" 
                onclick="proceedToBooking()" 
                class="w-full bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition duration-200 text-center font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          Check Availability
        </button>
        
        <p class="text-center text-sm text-gray-500 mt-3">You won't be charged yet</p>
        
        <!-- Quick booking stats -->
        <div class="mt-4 pt-4 border-t text-center">
          <div class="flex justify-center space-x-6 text-sm text-gray-600">
            <div class="flex items-center">
              <i class="fas fa-medal text-yellow-500 mr-1"></i>
              <span>Superhost</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-door-open text-green-500 mr-1"></i>
              <span>Self check-in</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-calendar-check text-blue-500 mr-1"></i>
              <span>Free cancellation</span>
            </div>
          </div>
        </div>
      </div>
      {% elif user.is_authenticated and user.role == 'host' and user == listing.host %}
      <!-- Host owns this property -->
      <div class="bg-blue-50 rounded-lg border border-blue-200 p-6 mb-6">
        <div class="text-center">
          <i class="fas fa-home text-blue-500 text-3xl mb-3"></i>
          <h3 class="text-lg font-semibold text-blue-900 mb-2">This is your listing</h3>
          <p class="text-blue-700 text-sm mb-4">Guests will see the booking widget here</p>
          <a href="{% url 'bookings:host_bookings' %}" 
             class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm font-medium">
            <i class="fas fa-calendar-alt mr-2"></i>View Bookings
          </a>
        </div>
      </div>
      {% elif not user.is_authenticated %}
      <!-- Not logged in -->
      <div class="bg-gray-50 rounded-lg border p-6 mb-6">
        <div class="text-center">
          <i class="fas fa-user-plus text-gray-400 text-3xl mb-3"></i>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Ready to book?</h3>
          <p class="text-gray-600 text-sm mb-4">Sign up or log in to start booking amazing places</p>
          <div class="space-y-2">
            <a href="{% url 'accounts:register' %}" 
               class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 text-center block font-medium">
              Sign Up
            </a>
            <a href="{% url 'accounts:login' %}" 
               class="w-full bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition duration-200 text-center block font-medium">
              Log In
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Host Information -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Hosted by</h3>
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
            {{ listing.host.username|first|upper }}
          </div>
          <div class="ml-4">
            <p class="font-semibold">{{ listing.host.username }}</p>
            <p class="text-sm text-gray-600">Joined {{ listing.host.date_joined|date:"M Y" }}</p>
          </div>
        </div>
        <p class="text-sm text-gray-600">
          Listed on {{ listing.created_at|date:"F j, Y" }}
        </p>
      </div>
    </div>
  </div>

  <!-- Related Houses Section - Only for Guests -->
  {% if user.is_authenticated and user.role == 'guest' and related_listings %}
  <div class="mt-16 border-t pt-12">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h2 class="text-2xl font-semibold text-gray-900">More places to stay</h2>
        <p class="text-gray-600 mt-1">Similar homes in {{ listing.location }}</p>
      </div>
      <a href="{% url 'listings:search' %}?q={{ listing.location|urlencode }}" 
         class="text-sm font-medium text-red-600 hover:text-red-700 hover:underline">
        Show all
      </a>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {% for related_listing in related_listings %}
      <div class="group cursor-pointer">
        <a href="{% url 'listings:detail' related_listing.pk %}" class="block">
          <div class="relative mb-3">
            {% if related_listing.image %}
              <img src="{{ related_listing.image.url }} " 
                   alt="{{ related_listing.title }}" 
                   class="w-full h-64 object-cover rounded-xl group-hover:scale-105 transition-transform duration-300" />
            {% else %}
              <div class="w-full h-64 bg-gray-200 rounded-xl flex items-center justify-center group-hover:scale-105 transition-transform duration-300">
                <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            {% endif %}
            
            <!-- Property Type Badge -->
            <div class="absolute top-3 left-3">
              <span class="bg-white bg-opacity-90 text-gray-800 px-2 py-1 rounded-lg text-xs font-medium shadow-sm">
                {{ related_listing.get_property_type_display }}
              </span>
            </div>
            
            <!-- Heart Icon -->
            <div class="absolute top-3 right-3">
              <button title="Add to wishlist" class="w-7 h-7 rounded-full bg-white bg-opacity-90 flex items-center justify-center hover:bg-opacity-100 transition-all duration-200">
                <svg class="w-4 h-4 text-gray-600 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
              </button>
            </div>
          </div>
          
          <div class="px-1">
            <!-- Location and Rating -->
            <div class="flex items-center justify-between mb-1">
              <h3 class="text-gray-900 font-medium text-sm truncate pr-2">{{ related_listing.location }}</h3>
              <div class="flex items-center flex-shrink-0">
                <svg class="w-3 h-3 text-gray-900" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                <span class="text-gray-900 text-sm font-medium ml-1">4.8</span>
              </div>
            </div>
            
            <!-- Title -->
            <p class="text-gray-600 text-sm mb-1 truncate">{{ related_listing.title }}</p>
            
            <!-- Guest count -->
            <p class="text-gray-600 text-sm mb-2">{{ related_listing.guests }} guest{{ related_listing.guests|pluralize }}</p>
            
            <!-- Price -->
            <div class="flex items-baseline">
              <span class="text-gray-900 font-semibold">${{ related_listing.price_per_night }}</span>
              <span class="text-gray-600 text-sm ml-1">night</span>
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    
    <!-- Show More Button -->
    <div class="text-center mt-8">
      <a href="{% url 'listing:search' %}?q={{ listing.location|urlencode }}" 
         class="inline-flex items-center px-6 py-3 border border-gray-900 text-base font-medium rounded-lg text-gray-900 bg-white hover:bg-gray-50 transition duration-200">
        Show more places to stay
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </div>
  {% endif %}
</div>

<!-- Booking Widget JavaScript -->
{% if user.is_authenticated and user.role == 'guest' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkinInput = document.getElementById('preview-checkin');
    const checkoutInput = document.getElementById('preview-checkout');
    const guestsSelect = document.getElementById('preview-guests');
    const bookBtn = document.getElementById('book-now-btn');
    const priceBreakdown = document.getElementById('price-breakdown');
    const availabilityStatus = document.getElementById('availability-status');
    const nightsDisplay = document.getElementById('nights-display');
    const subtotalDisplay = document.getElementById('subtotal-display');
    const totalDisplay = document.getElementById('total-display');
    const availableMessage = document.getElementById('available-message');
    const unavailableMessage = document.getElementById('unavailable-message');
    const loadingMessage = document.getElementById('loading-message');
    
    const pricePerNight = {{ listing.price_per_night }};
    let isAvailable = false;
    let totalPrice = 0;
    let nights = 0;
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    checkinInput.setAttribute('min', today);
    checkoutInput.setAttribute('min', today);
    
    function updateMinCheckout() {
        if (checkinInput.value) {
            const checkinDate = new Date(checkinInput.value);
            checkinDate.setDate(checkinDate.getDate() + 1);
            checkoutInput.setAttribute('min', checkinDate.toISOString().split('T')[0]);
            
            // Clear checkout if it's now invalid
            if (checkoutInput.value && checkoutInput.value <= checkinInput.value) {
                checkoutInput.value = '';
            }
        }
    }
    
    function calculatePrice() {
        if (checkinInput.value && checkoutInput.value) {
            const checkin = new Date(checkinInput.value);
            const checkout = new Date(checkoutInput.value);
            nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
            
            if (nights > 0) {
                totalPrice = nights * pricePerNight;
                nightsDisplay.textContent = nights;
                subtotalDisplay.textContent = '$' + totalPrice.toFixed(2);
                totalDisplay.textContent = '$' + totalPrice.toFixed(2);
                priceBreakdown.classList.remove('hidden');
                
                checkAvailability();
            } else {
                priceBreakdown.classList.add('hidden');
                hideAvailabilityStatus();
                bookBtn.disabled = true;
                bookBtn.textContent = 'Check Availability';
            }
        } else {
            priceBreakdown.classList.add('hidden');
            hideAvailabilityStatus();
            bookBtn.disabled = true;
            bookBtn.textContent = 'Check Availability';
        }
    }
    
    function hideAvailabilityStatus() {
        availableMessage.classList.add('hidden');
        unavailableMessage.classList.add('hidden');
        loadingMessage.classList.add('hidden');
        availabilityStatus.classList.add('hidden');
    }
    
    function showLoading() {
        hideAvailabilityStatus();
        loadingMessage.classList.remove('hidden');
        availabilityStatus.classList.remove('hidden');
        bookBtn.disabled = true;
        bookBtn.textContent = 'Checking...';
    }
    
    function checkAvailability() {
        if (checkinInput.value && checkoutInput.value && nights > 0) {
            showLoading();
            
            fetch(`{% url 'bookings:check_availability' %}?listing_id={{ listing.id }}&check_in=${checkinInput.value}&check_out=${checkoutInput.value}`)
                .then(response => response.json())
                .then(data => {
                    hideAvailabilityStatus();
                    availabilityStatus.classList.remove('hidden');
                    
                    if (data.available) {
                        availableMessage.classList.remove('hidden');
                        bookBtn.disabled = false;
                        bookBtn.textContent = 'Reserve';
                        bookBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        bookBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        isAvailable = true;
                    } else {
                        unavailableMessage.classList.remove('hidden');
                        bookBtn.disabled = true;
                        bookBtn.textContent = 'Not Available';
                        bookBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        bookBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                        isAvailable = false;
                    }
                })
                .catch(error => {
                    console.error('Error checking availability:', error);
                    hideAvailabilityStatus();
                    bookBtn.disabled = true;
                    bookBtn.textContent = 'Error - Try Again';
                });
        }
    }
    
    // Event listeners
    checkinInput.addEventListener('change', function() {
        updateMinCheckout();
        calculatePrice();
    });
    
    checkoutInput.addEventListener('change', calculatePrice);
    guestsSelect.addEventListener('change', calculatePrice);
    
    // Initialize
    updateMinCheckout();
});

function proceedToBooking() {
    const checkin = document.getElementById('preview-checkin').value;
    const checkout = document.getElementById('preview-checkout').value;
    const guests = document.getElementById('preview-guests').value;
    
    if (!checkin || !checkout || !guests) {
        alert('Please select your check-in date, check-out date, and number of guests.');
        return;
    }
    
    // Create a form and submit with the selected dates
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "bookings:create_booking" listing_id=listing.id %}';
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    // Add form data
    const checkinInput = document.createElement('input');
    checkinInput.type = 'hidden';
    checkinInput.name = 'check_in';
    checkinInput.value = checkin;
    form.appendChild(checkinInput);
    
    const checkoutInput = document.createElement('input');
    checkoutInput.type = 'hidden';
    checkoutInput.name = 'check_out';
    checkoutInput.value = checkout;
    form.appendChild(checkoutInput);
    
    const guestsInput = document.createElement('input');
    guestsInput.type = 'hidden';
    guestsInput.name = 'guests';
    guestsInput.value = guests;
    form.appendChild(guestsInput);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endif %}
{% endblock %}
