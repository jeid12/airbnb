{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-8 mb-8">
        <div class="text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-credit-card text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Complete Your Payment</h1>
            <p class="text-blue-100">Secure payment for your booking</p>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Booking Summary -->
        <div class="space-y-6">
            <!-- Property Details -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Booking Summary</h3>
                
                <div class="flex items-start space-x-4 mb-6">
                    {% if booking.listing.image %}
                        <img src="{{ booking.listing.image.url }}" alt="{{ booking.listing.title }}" 
                             class="w-20 h-20 object-cover rounded-lg">
                    {% endif %}
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900">{{ booking.listing.title }}</h4>
                        <p class="text-gray-600 text-sm mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i>{{ booking.listing.location }}
                        </p>
                        <p class="text-sm text-gray-500 mt-1">{{ booking.booking_reference }}</p>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Check-in:</span>
                        <span class="text-gray-900">{{ booking.check_in|date:"M d, Y" }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Check-out:</span>
                        <span class="text-gray-900">{{ booking.check_out|date:"M d, Y" }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Nights:</span>
                        <span class="text-gray-900">{{ booking.nights }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Guests:</span>
                        <span class="text-gray-900">{{ booking.guests }}</span>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">${{ booking.listing.price_per_night }} × {{ booking.nights }} nights</span>
                            <span class="text-gray-900">${{ booking.total_price }}</span>
                        </div>
                        <div class="border-t pt-2">
                            <div class="flex justify-between text-lg font-bold">
                                <span>Total (USD)</span>
                                <span class="text-green-600">${{ booking.total_price }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Security -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h4 class="font-semibold text-green-900 mb-3">
                    <i class="fas fa-shield-alt mr-2"></i>Secure Payment
                </h4>
                <ul class="text-green-800 text-sm space-y-2">
                    <li>• SSL encrypted connection</li>
                    <li>• PayPal buyer protection</li>
                    <li>• No payment details stored</li>
                    <li>• Cancel anytime before check-in</li>
                </ul>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Payment Method</h3>
                
                <!-- PayPal Payment -->
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fab fa-paypal text-2xl text-blue-600 mr-3"></i>
                        <span class="text-lg font-medium">Pay with PayPal</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        Pay securely with your PayPal account or credit card. You'll be redirected to PayPal to complete your payment.
                    </p>
                    
                    <!-- PayPal Button Container -->
                    <div id="paypal-button-container"></div>
                    
                    <!-- Loading State -->
                    <div id="payment-loading" class="hidden text-center py-4">
                        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-blue-500">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing payment...
                        </div>
                    </div>
                </div>

                <!-- Alternative Payment Info -->
                <div class="border-t pt-6">
                    <h4 class="font-medium text-gray-900 mb-3">Don't have PayPal?</h4>
                    <p class="text-sm text-gray-600">
                        No problem! You can pay with your credit or debit card through PayPal's secure checkout without creating an account.
                    </p>
                </div>
            </div>

            <!-- Booking Policies -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="font-medium text-gray-900 mb-3">Payment & Cancellation Policy</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                    <li>• Payment is processed immediately</li>
                    <li>• Booking confirmed after successful payment</li>
                    <li>• Free cancellation before check-in date</li>
                    <li>• Refunds processed within 5-7 business days</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>

<script>
// PayPal Integration
paypal.Buttons({
    // Set up the transaction
    createOrder: function(data, actions) {
        // Show loading state
        document.getElementById('payment-loading').classList.remove('hidden');
        document.getElementById('paypal-button-container').style.opacity = '0.5';
        
        return fetch('{% url "bookings:create_paypal_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                booking_id: {{ booking.id }}
            })
        }).then(function(response) {
            return response.json();
        }).then(function(orderData) {
            // Hide loading state
            document.getElementById('payment-loading').classList.add('hidden');
            document.getElementById('paypal-button-container').style.opacity = '1';
            
            if (orderData.error) {
                alert('Error creating payment: ' + orderData.error);
                return null;
            }
            return orderData.id;
        }).catch(function(error) {
            // Hide loading state
            document.getElementById('payment-loading').classList.add('hidden');
            document.getElementById('paypal-button-container').style.opacity = '1';
            
            console.error('Error:', error);
            alert('Error creating payment. Please try again.');
            return null;
        });
    },

    // Finalize the transaction
    onApprove: function(data, actions) {
        // Show loading state
        document.getElementById('payment-loading').classList.remove('hidden');
        document.getElementById('paypal-button-container').style.opacity = '0.5';
        
        return fetch(`{% url "bookings:capture_paypal_order" order_id="PLACEHOLDER" %}`.replace('PLACEHOLDER', data.orderID), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        }).then(function(response) {
            return response.json();
        }).then(function(orderData) {
            if (orderData.status === 'success') {
                // Payment successful
                window.location.href = '{% url "bookings:payment_success" booking_id=booking.id %}';
            } else {
                // Payment failed
                alert('Payment failed: ' + (orderData.error || 'Unknown error'));
                document.getElementById('payment-loading').classList.add('hidden');
                document.getElementById('paypal-button-container').style.opacity = '1';
            }
        }).catch(function(error) {
            console.error('Error:', error);
            alert('Error processing payment. Please try again.');
            document.getElementById('payment-loading').classList.add('hidden');
            document.getElementById('paypal-button-container').style.opacity = '1';
        });
    },

    // Handle errors
    onError: function(err) {
        console.error('PayPal error:', err);
        alert('An error occurred with PayPal. Please try again.');
        document.getElementById('payment-loading').classList.add('hidden');
        document.getElementById('paypal-button-container').style.opacity = '1';
    },

    // Handle cancelled payments
    onCancel: function(data) {
        console.log('Payment cancelled:', data);
        window.location.href = '{% url "bookings:payment_cancel" booking_id=booking.id %}';
    }

}).render('#paypal-button-container');
</script>
{% endblock %}
